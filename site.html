<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Oahu Trip Map — Sheets API with Toggleable Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap"
    rel="stylesheet"
  />
  <style>
    body, html { margin:0; height:100%; font-family:sans-serif; }
    #map { height:100%; }

    /* Filters container—collapsed by default */
    .filters {
      position:absolute; top:10px; left:10px; z-index:1000;
      background: rgba(255,249,230,0.95);
      border-radius:8px;
      overflow: hidden;
      width: auto;
      max-height: 40px;            /* only enough for the toggle button */
      transition: width 0.3s ease, max-height 0.3s ease;
    }
    /* Expanded state */
    .filters.expanded {
      width: 280px;
      max-height: 80vh;           /* allow scrolling if content is tall */
      overflow-y: auto;
    }
    /* Toggle button inside filters */
    #toggleFilters {
      display: block;
      width: 100%;
      padding: 8px;
      background: #FFECB3;
      border: none;
      border-bottom: 1px solid #ddd;
      font-family: 'Rock Salt', cursive;
      font-size: 1em;
      cursor: pointer;
    }

    .panel { margin-bottom:10px; }
    .panel-header {
      display:flex; align-items:center; padding:8px;
      background:#FFECB3; border-radius:6px;
      cursor:pointer; font-family:'Rock Salt',cursive;
      font-size:1.1em; transition:background .2s;
    }
    .panel-header:hover { background:#FFE082; }
    .panel-header input[type="checkbox"] { margin-right:8px; }
    .panel-header .color-swatch {
      margin-left:auto; width:14px; height:14px;
      border-radius:50%; border:1px solid #999;
      box-shadow:0 0 2px rgba(0,0,0,0.2);
    }
    .panel-header .arrow { margin-left:8px; font-weight:bold; }
    .panel-body {
      display:none; padding:12px 8px 8px 20px; background:#FFF8E1;
      border-radius:6px;
    }
    .panel-body.active { display:block; }

    /* each checkbox on its own line */
    .panel-body label {
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="filters" id="filters">
    <button id="toggleFilters">Show Filters</button>
    <!-- panels will be injected here -->
  </div>

  <div id="map"></div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    // ─── CONFIG ───────────────────────────────────────────────────────────────
    const sheetId = '1XBG0uONiQoPvUxqz6V4BJBsOckDM2cahH4WylqOdz74';
    const apiKey  = 'AIzaSyDiUAu4Uii6gAltbyJ8G2UkLMUdydyd9Jw';
    // include AppleMapsLink in the range
    const range   = 'Sheet1!A:I';  // Name,Category,Subcategory,Region,Notes,Coordinates,MapsLink,Visited,AppleMapsLink

    const jsonUrl =
      `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}`
      + `/values/${encodeURIComponent(range)}?key=${apiKey}`;

    // ─── Initialize map without default zoom, then add it top-right ─────────
    const map = L.map('map', { zoomControl: false })
      .setView([21.3069, -157.8583], 11);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution:'© Humanitarian OSM Team © OpenStreetMap contributors'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    const filtersDiv   = document.getElementById('filters');
    const toggleBtn    = document.getElementById('toggleFilters');

    // Toggle the filters panel
    toggleBtn.onclick = () => {
      const open = filtersDiv.classList.toggle('expanded');
      toggleBtn.textContent = open ? 'Hide Filters' : 'Show Filters';
    };

    // ─── Fetch & parse via Sheets API ────────────────────────────────────────
    fetch(jsonUrl)
      .then(res => {
        if (!res.ok) throw new Error('Sheets API error: ' + res.statusText);
        return res.json();
      })
      .then(data => {
        const values = data.values;
        if (!values || values.length < 2) {
          throw new Error('No data returned from sheet');
        }
        const headers = values[0];
        const rows = values.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => { obj[h] = row[i] || ''; });
          return obj;
        });
        buildMap(rows);
      })
      .catch(err => {
        console.error('Could not load from Sheets API:', err);
      });

    // ─── SVG icon factory with visited outline ──────────────────────────────
    function createSvgIcon(color, visited) {
      const stroke = visited ? '#DAA520' : '#555';
      const svg = `
<svg width="24" height="35" viewBox="0 0 24 35" xmlns="http://www.w3.org/2000/svg">
  <path fill="${color}" stroke="${stroke}" stroke-width="2"
    d="M12 0C7.03 0 3 4.03 3 9
       c0 6.75 9 19.5 9 19.5
       s9-12.75 9-19.5
       c0-4.97-4.03-9-9-9
       zm0 13.5a4.5 4.5 0 1 1 0-9
       4.5 4.5 0 0 1 0 9z"/>
</svg>`;
      return L.divIcon({
        html: svg,
        iconSize:   [24,35],
        iconAnchor: [12,35],
        popupAnchor:[0,-35],
        className:  ''
      });
    }

    // ─── Main builder: filters + markers ─────────────────────────────────────
    function buildMap(rows) {
      // Normalize rows
      const places = rows
        .filter(r => r.Name && r.Coordinates && r.Category && r.Subcategory)
        .map(r => {
          const [lat, lng] = r.Coordinates.split(',').map(s => parseFloat(s.trim()));
          return {
            name:           r.Name,
            category:       r.Category.trim(),
            subcategory:    r.Subcategory.trim(),
            region:         r.Region || '',
            notes:          r.Notes || '',
            visited:        (r.Visited||'').trim().toUpperCase() === 'Y',
            lat, lng,
            mapsLink:       r.MapsLink || '',
            // accommodate both possible header names
            appleMapsLink:  r.AppleMapsLink || r['Apple Maps Link'] || ''
          };
        });

      // Build category→subs & collect regions
      const categoryMap = {}, allRegions = new Set();
      places.forEach(p => {
        (categoryMap[p.category] ||= new Set()).add(p.subcategory);
        if (p.region) allRegions.add(p.region);
      });

      // Colors per category
      const cats = Object.keys(categoryMap);
      function hslToHex(h,s,l){ l/=100; const a=s*Math.min(l,1-l)/100;
        const f=n=>{ const k=(n+h/30)%12;
          const c=l - a*Math.max(Math.min(k-3,9-k,1),-1);
          return Math.round(255*c).toString(16).padStart(2,'0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }
      const categoryColors = {};
      cats.forEach((c,i)=>categoryColors[c]=hslToHex(Math.round(i*360/cats.length),60,50));

      // Selection sets
      const selectedSubs    = new Set(places.map(p=>`${p.category} - ${p.subcategory}`));
      const selectedRegs    = new Set(allRegions);
      const selectedVisited = new Set(['Been there','Not yet']);

      // Helper to make a checkbox label
      function makeCheckbox(val, set, labelText) {
        const lbl = document.createElement('label');
        const cb  = document.createElement('input');
        cb.type = 'checkbox'; cb.value = val; cb.checked = true;
        cb.onchange = () => {
          cb.checked ? set.add(val) : set.delete(val);
          drawMarkers();
        };
        lbl.append(cb, ' ' + labelText);
        return lbl;
      }

      // Build panels into the filters div
      function buildPanel(title, items, isRegion, isVisited=false) {
        const pnl = document.createElement('div'); pnl.className='panel';
        const hdr = document.createElement('div'); hdr.className='panel-header';

        let master = null;
        if (!isRegion && !isVisited) {
          master = document.createElement('input');
          master.type='checkbox'; master.checked=true;
          master.onchange = () => {
            const allChecked = master.checked;
            pnl.querySelectorAll('input[type=checkbox]').forEach(cb=>{
              if (cb!==master) {
                cb.checked = allChecked;
                const key = cb.value;
                allChecked ? selectedSubs.add(key) : selectedSubs.delete(key);
              }
            });
            drawMarkers();
          };
          hdr.append(master);
        }

        hdr.append(document.createTextNode(title));

        if (!isRegion && !isVisited) {
          const sw = document.createElement('div');
          sw.className='color-swatch';
          sw.style.background = categoryColors[title];
          hdr.append(sw);
        }

        const arrow = document.createElement('span');
        arrow.className='arrow'; arrow.textContent='▶';
        hdr.append(arrow);

        const body = document.createElement('div'); body.className='panel-body';
        items.forEach(item=>{
          const fullVal = isRegion ? item
                          : isVisited ? item
                          : `${title} - ${item}`;
          body.append(makeCheckbox(fullVal,
            isRegion   ? selectedRegs
            : isVisited? selectedVisited
            : selectedSubs,
            item));
        });

        hdr.addEventListener('click', ()=>{
          const open = body.classList.toggle('active');
          arrow.textContent = open ? '▼' : '▶';
        });

        pnl.append(hdr, body);
        filtersDiv.appendChild(pnl);
      }

      // Inject panels
      cats.sort().forEach(c=> buildPanel(c, Array.from(categoryMap[c]).sort(), false, false));
      if (allRegions.size) buildPanel('Regions', Array.from(allRegions).sort(), true, false);
      buildPanel('Visited', ['Been there','Not yet'], false, true);

      // Draw markers
      function drawMarkers() {
        markersLayer.clearLayers();
        places.forEach(p=>{
          if (!selectedVisited.has(p.visited ? 'Been there' : 'Not yet')) return;
          const key = `${p.category} - ${p.subcategory}`;
          if (!selectedSubs.has(key)) return;
          if (p.region && !selectedRegs.has(p.region)) return;

          L.marker([p.lat,p.lng], {
            icon: createSvgIcon(categoryColors[p.category], p.visited)
          })
          .bindPopup(
            `<strong>${p.name}</strong><br>` +
            `${p.notes}<br>` +
            `<em>${p.category} – ${p.subcategory}` +
            (p.region ? ` / ${p.region}` : '') +
            `</em><br>` +
            `<a href="${p.mapsLink}" target="_blank">Google Maps</a>` +
            (p.appleMapsLink
              ? `<br><a href="${p.appleMapsLink}" target="_blank">Apple Maps</a>`
              : ''
            )
          )
          .addTo(markersLayer);
        });
      }

      // initial draw
      drawMarkers();
    }
  })();
  </script>
</body>
</html>
