<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oahu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin="" />

  <!-- Fallback Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap"
    rel="stylesheet" />

  <style>
    /**************************
     *  CONFIGURATION SECTION *
     **************************/
    /* Fonts to swap easily */
    @font-face { font-family: 'Bardy'; src: url('/MapResources/fonts/Bardy.woff') format('woff'); }
    @font-face { font-family: 'Dorgan'; src: url('/MapResources/fonts/Dorgan.woff') format('woff'); }

    /**************************
     *    STYLE SECTION       *
     **************************/
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif; /* fallback */
    }
    #map { width: 100%; height: 100%; }
    .leaflet-div-icon { background: transparent !important; border: none !important; }

    /* Filters container */
    .filters {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,249,230,0.95); border-radius: 8px;
      overflow: hidden; max-height: 40px; width: auto;
      transition: max-height 0.3s, width 0.3s;
    }
    .filters.expanded {
      max-height: calc(100vh - 20px); width: 280px; overflow-y: auto;
    }

    /* Toggle Button */
    #toggleFilters {
      display: block; width: 100%; padding: 8px;
      background: #E7D8C4; border: none; border-bottom: 1px solid #ddd;
      font-family: 'Dorgan', cursive; cursor: pointer;
    }

    /* Panel Headers */
    .panel { margin: 8px; }
    .panel-header {
      display: flex; align-items: center; padding: 6px 8px;
      background: #E7D8C4; border-radius: 6px; cursor: pointer;
      font-family: 'Bardy', cursive; font-size: 1.6em;
      color: #E3B505; text-shadow: 2px 2px 0 #DB504A;
    }
    /* Checkbox & Emoji */
    .panel-header input[type="checkbox"],
    .panel-body input[type="checkbox"] {
      appearance: none; width: 18px; height: 18px;
      margin-right: 12px; border: 2px solid #D0B59A;
      border-radius: 3px; position: relative; cursor: pointer;
    }
    input[type="checkbox"]:checked { border: none; }
    input[type="checkbox"]:checked::after {
      content: attr(data-emoji);
      position: absolute; top: -2px; left: -2px;
      font-size: 22px; line-height: 18px;
      pointer-events: none;
    }
    .panel-header .color-swatch {
      margin-left: auto; width: 14px; height: 14px;
      border-radius: 50%; border: 1px solid #999;
    }
    .panel-header .arrow { margin-left: 8px; font-weight: bold; }

    /* Panel Bodies */
    .panel-body { display: none; padding: 8px 12px;
      background: #FAF1D2; border-radius: 6px;
    }
    .panel-body.active { display: block; }
    .panel-body label {
      display: block; margin-bottom: 6px;
      font-family: 'Dorgan', sans-serif; font-size: 1.1em;
      position: relative;
    }

    /* Popup Styling */
    .leaflet-popup-content-wrapper {
      max-height: 80vh; overflow: auto;
      font-family: 'Dorgan', sans-serif;
    }
    .review-carousel {
      display: flex; overflow-x: auto; gap: 8px; padding: 6px 0;
    }
    .review-item {
      flex: 0 0 180px; background: #fff;
      border: 1px solid #ddd; padding: 6px;
      border-radius: 4px; box-sizing: border-box;
    }
    .review-item a { display: block; margin-top: 4px; font-size: 0.9em; }
    .review-item strong { display: block; margin-bottom: 4px; }
    .review-item p { margin: 0 0 4px; }
  </style>
</head>
<body>

  <!-- Filters Container -->
  <div class="filters" id="filters">
    <button id="toggleFilters">Show Filters</button>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    /**************************
     *    DATA & CONFIG       *
     **************************/
    const CONFIG = {
      sheetId: '1XBG0uONiQoPvUxqz6V4BJBsOckDM2cahH4WylqOdz74',
      apiKey: 'AIzaSyDiUAu4Uii6gAltbyJ8G2UkLMUdydyd9Jw',
      ranges: ['Places!A:J','Reviews!A:E'],
      mapCenter: [21.3069, -157.8583],
      mapZoom: 10,
      tileUrl: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
      attribution: '<a href="https://www.youtube.com/watch?v=rzLIUgnKY40">Home</a>',
      baseColors: ['#FCBF49','#D62828','#E8B5BD','#4D7D5C','#528ED1','#DEFF8D'],
      emojiList: ['ðŸ¤™ðŸ¼','ðŸ§œðŸ¼â€â™€ï¸','ðŸ„ðŸ¼â€â™‚ï¸','ðŸ„ðŸ»â€â™€ï¸','ðŸ“','ðŸ‹','ðŸ ','ðŸ¦ˆ','ðŸª¸','ðŸª¼','ðŸŒº','ðŸ¥¥','ðŸ','ðŸ§','ðŸ¤¿','ðŸŒ‹','ðŸï¸','ðŸ›µ','ðŸ‘™','ðŸŒ´','â›±ï¸'],
      userIconUrl: '/MapResources/PNGs/Hula1.png',
    };

    (function(){
      function shuffle(a){ let m=a.length; while(m){ const i=Math.floor(Math.random()*m--); [a[m],a[i]]=[a[i],a[m]];} return a; }
      function randomColor(){ const h=Math.floor(Math.random()*360); return `hsl(${h},60%,50%)`; }

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.sheetId}`
                + `/values:batchGet?key=${CONFIG.apiKey}`
                + CONFIG.ranges.map(r=>`&ranges=${encodeURIComponent(r)}`).join('');

      fetch(url)
        .then(r=>r.ok?r.json():Promise.reject(r.statusText))
        .then(data=>{
          const [hdrP,...rowsP] = data.valueRanges[0].values;
          const places = rowsP.map(r=>{ const o=Object.fromEntries(hdrP.map((h,i)=>[h,r[i]||''])); const [lat,lng]=o.Coordinates.split(',').map(Number); return { id:o.PlaceID,name:o.Name,category:o.Category,subcategory:o.Subcategory,region:o.Region,notes:o.Notes,visited:o.Visited.trim().toUpperCase()==='Y',latlng:[lat,lng],mapsLink:o.MapsLink,appleLink:o.AppleMapsLink }; });
          const [hdrR,...rowsR] = data.valueRanges[1].values;
          const reviewsBy={}; rowsR.forEach(r=>{ const o=Object.fromEntries(hdrR.map((h,i)=>[h,r[i]||''])); const photos=(o.PhotoURL||'').trim().split(/\s*,\s*/).filter(Boolean); (reviewsBy[o.PlaceID]||=[]).push({date:o.VisitDate, rating:+o.Rating||0, text:o.Review, photos}); });
          initMap(places,reviewsBy);
        }).catch(console.error);

      function initMap(places,reviewsBy){
        const map=L.map('map',{zoomControl:false}).setView(CONFIG.mapCenter,CONFIG.mapZoom);
        map.attributionControl.setPrefix(''); 
        L.control.zoom({position:'topright'}).addTo(map);
        L.tileLayer(CONFIG.tileUrl,{attribution:CONFIG.attribution}).addTo(map);
         // â˜… Dynamically load & size the user-location icon â˜…
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const img = new Image();
      img.src = CONFIG.userIconUrl;

      img.onload = () => {
        const maxWidth = 32;                   // desired width in px
        const ratio    = img.height / img.width;
        const w        = maxWidth;
        const h        = Math.round(maxWidth * ratio);

        const userIcon = L.icon({
          iconUrl:     CONFIG.userIconUrl,
          iconSize:    [w, h],
          iconAnchor:  [w / 2, h],
          popupAnchor: [0, -h]
        });

        L.marker([latitude, longitude], { icon: userIcon })
          .addTo(map)
          .bindPopup('You are here.')
          .openPopup();
      };
    }, err => {
      console.warn('Geolocation failed:', err.message);
    });
  }
        const markerLayer=L.layerGroup().addTo(map);
        const catMap={},regSet=new Set(); places.forEach(p=>{ (catMap[p.category]||(catMap[p.category]=new Set())).add(p.subcategory); if(p.region) regSet.add(p.region); });
        const selSub=new Set(places.map(p=>`${p.category} - ${p.subcategory}`)); const selReg=new Set(regSet); const selVis=new Set(['Been there','Not yet']);
        const basePool=CONFIG.baseColors.slice(); shuffle(basePool);
        const categoryColors={}; Object.keys(catMap).forEach(cat=>{ categoryColors[cat]=basePool.length?basePool.pop():randomColor(); });
        setupFilters(Object.keys(catMap),regSet,catMap);
        drawMarkers();
        function setupFilters(categories,regions,catMap){
          const fd=document.getElementById('filters');
          document.getElementById('toggleFilters').onclick=()=>{ const ex=fd.classList.toggle('expanded'); document.getElementById('toggleFilters').textContent=ex?'Hide Filters':'Show Filters'; };
          function makeCB(val,setRef,label){ const lbl=document.createElement('label'); const cb=document.createElement('input'); cb.type='checkbox'; cb.value=val; cb.checked=true; cb.dataset.emoji=CONFIG.emojiList[Math.floor(Math.random()*CONFIG.emojiList.length)]; cb.onchange=()=>{ cb.checked?setRef.add(val):setRef.delete(val); drawMarkers(); }; lbl.append(cb,' ',label); return lbl; }
          function addPanel(title,items,isRegion=false,masterOnly=false){ const p=document.createElement('div'); p.className='panel'; const h=document.createElement('div'); h.className='panel-header'; if(!masterOnly){ const m=document.createElement('input'); m.type='checkbox'; m.checked=true; m.dataset.emoji=CONFIG.emojiList[Math.floor(Math.random()*CONFIG.emojiList.length)]; m.onclick=e=>e.stopPropagation(); m.onchange=()=>{ p.querySelectorAll('input[type=checkbox]').forEach(cb=>{ if(cb!==m){ cb.checked=m.checked; const k=cb.value; isRegion? (m.checked?selReg.add(k):selReg.delete(k)):(m.checked?selSub.add(k):selSub.delete(k)); }}); drawMarkers(); }; h.append(m); } h.append(document.createTextNode(title)); if(!isRegion&&title!=='Visited'){ const sw=document.createElement('div'); sw.className='color-swatch'; sw.style.background=categoryColors[title]; h.append(sw); } const arr=document.createElement('span'); arr.className='arrow'; arr.textContent='â–¶'; h.append(arr); const b=document.createElement('div'); b.className='panel-body'; items.forEach(it=>b.append(makeCB(isRegion?it:`${title} - ${it}`, isRegion?selReg:selSub, it))); h.onclick=()=>{ const o=b.classList.toggle('active'); arr.textContent=o?'â–¼':'â–¶'; }; p.append(h,b); fd.append(p); }
          if(regions.size) addPanel('Region',[...regions].sort(),true);
          addPanel('Visited',['Been there','Not yet'],false,true);
          if(categories.includes('Food')) addPanel('Food',[...catMap['Food']].sort(),false);
          if(categories.includes('Sweet Treats')) addPanel('Sweet Treats',[...catMap['Sweet Treats']].sort(),false);
          categories.filter(c=>c!=='Food'&&c!=='Sweet Treats').sort().forEach(c=>addPanel(c,[...catMap[c]].sort()));
        }
        function drawMarkers(){ markerLayer.clearLayers(); places.forEach(p=>{ if(!selVis.has(p.visited?'Been there':'Not yet')) return; if(!selSub.has(`${p.category} - ${p.subcategory}`)) return; if(p.region&&!selReg.has(p.region)) return; let popup=`<strong>${p.name}</strong><br>${p.notes||''}<br><em>${p.category} â€“ ${p.subcategory}`+(p.region?` / ${p.region}`:'')+`</em><br>`; const revs=(reviewsBy[p.id]||[]).sort((a,b)=>b.date.localeCompare(a.date)); if(revs.length){ popup+='â˜…'.repeat(revs[0].rating)+'<br><details><summary>'+revs.length+' review'+(revs.length>1?'s':'')+'</summary><div class="review-carousel">'; revs.forEach(r=>{ popup+=`<div class="review-item"><strong>${r.date}</strong><p>${r.text}</p>`; r.photos.forEach(u=>popup+=`<a href="${u}" target="_blank">View photo</a>`); popup+='</div>'; }); popup+='</div></details>'; } if(p.mapsLink) popup+=`<a href="${p.mapsLink}" target="_blank">Google Maps</a>`; if(p.appleLink) popup+=`<br><a href="${p.appleLink}" target="_blank">Apple Maps</a>`; const strokeColor=p.visited?'#DAA520':'#555'; const svgIcon=`<svg width="24" height="35" viewBox="0 0 24 35" xmlns="http://www.w3.org/2000/svg"><path fill="${categoryColors[p.category]}" stroke="${strokeColor}" stroke-width="2" d="M12 0C7.03 0 3 4.03 3 9 c0 6.75 9 19.5 9 19.5 s9-12.75 9-19.5 c0-4.97-4.03-9-9-9 zm0 13.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"/></svg>`; L.marker(p.latlng,{icon:L.divIcon({html:svgIcon,className:'leaflet-div-icon',iconSize:[24,35],iconAnchor:[12,35],popupAnchor:[0,-35]})}).bindPopup(popup,{autoPan:true}).addTo(markerLayer); }); }
      }
    })();
  </script>
</body>
</html>
