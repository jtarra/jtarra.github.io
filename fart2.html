<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Oahu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    /* 0) Custom Fonts */
    @font-face {
      font-family: 'Bardy';
      src: url('/MapResources/fonts/Bardy.woff') format('woff');
    }
    @font-face {
      font-family: 'Balkey';
      src: url('/MapResources/fonts/Balkey.woff') format('woff');
    }

    /* 1) Base & Leaflet Overrides */
    body, html { margin:0; height:100%; }
    #map { height:100%; }
    .leaflet-div-icon { background:transparent!important; border:none!important; }

    /* 2) Filters Panel */
    .filters {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:rgba(255,249,230,0.95); border-radius:8px;
      overflow:hidden; max-height:40px; width:auto;
      transition:max-height .3s,width .3s;
      pointer-events:none; /* let clicks through when collapsed */
    }
    .filters.expanded {
      max-height:calc(100vh - 20px);
      width:280px; overflow-y:auto;
      background-clip:padding-box;
      pointer-events:auto;
    }
    .filters.expanded *, .filters * { pointer-events:auto; }

    /* 3) Toggle Button */
    #toggleFilters {
      display:block; width:100%; padding:8px; margin:0;
      background:#FFECB3; border:none; border-bottom:1px solid #ddd;
      font-family:'Balkey',sans-serif;
      font-size:1em; cursor:pointer;
      text-shadow:1px 1px 0 rgba(255,255,255,0.7), -1px -1px 0 rgba(0,0,0,0.2);
    }

    /* 4) Panel Headers */
    .panel { margin:8px; }
    .panel-header {
      position:relative;
      display:flex; align-items:center; padding:6px 8px;
      background:#FFECB3; border-radius:6px;
      cursor:pointer;
      font-family:'Bardy',cursive;
      font-size:1.4em;
      text-shadow:1px 1px 0 rgba(255,255,255,0.7), -1px -1px 0 rgba(0,0,0,0.2);
    }
    .panel-header::before {
      content:'';
      position:absolute; top:4px; left:0px;
      width:12px; height:12px;
      background:rgba(233,30,99,0.3);
      border-radius:50%; transform:rotate(-30deg);
    }
    .panel-header .master-toggle {
      margin-right:8px;
      font-size:1.2em;
      cursor:pointer;
    }
    .panel-header input[type="checkbox"] { display:none; }
    .panel-header .color-swatch {
      margin-left:auto; width:14px; height:14px;
      border-radius:50%; border:1px solid #999;
    }
    .panel-header .arrow {
      margin-left:8px; font-size:1.2em;
    }

    /* 5) Panel Bodies & Checkboxes */
    .panel-body {
      display:none; padding:8px 12px; background:#FFF8E1;
      border-radius:6px;
      font-family:'Balkey',sans-serif;
      font-size:0.95em; color:#333;
    }
    .panel-body.active { display:block; }
    .panel-body label {
      display:flex; align-items:center; margin-bottom:6px;
    }
    .panel-body input[type="checkbox"] {
      appearance:none; width:18px; height:18px;
      margin-right:8px; border:2px solid #FF5722;
      border-radius:4px; position:relative; cursor:pointer;
    }
    .panel-body input[type="checkbox"]:checked::after {
      content:'ðŸŒº';
      position:absolute; top:-3px; left:-2px;
      font-size:24px; line-height:18px; pointer-events:none;
    }

    /* 6) Popup Content */
    .leaflet-popup-content-wrapper {
      max-height:80vh; overflow:auto;
      font-family:'Balkey',sans-serif;
    }
    .leaflet-popup-content-wrapper p,
    .leaflet-popup-content-wrapper strong,
    .leaflet-popup-content-wrapper a {
      font-family:inherit;
    }

    /* 7) Reviews Carousel */
    .review-carousel {
      display:flex; overflow-x:auto; gap:8px; padding:6px 0;
    }
    .review-item {
      flex:0 0 180px; background:#fff; border:1px solid #ddd;
      padding:6px; border-radius:4px; box-sizing:border-box;
    }
    .review-item a { display:block; margin-top:4px; font-size:0.9em; }
  </style>
</head>
<body>
  <div class="filters" id="filters">
    <button id="toggleFilters">Show Filters</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    const sheetId='1XBG0uONiQoPvUxqz6V4BJBsOckDM2cahH4WylqOdz74',
          apiKey ='AIzaSyDiUAu4Uii6gAltbyJ8G2UkLMUdydyd9Jw',
          ranges =['Places!A:J','Reviews!A:E'];
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values:batchGet?key=${apiKey}`
                + ranges.map(r=>'&ranges='+encodeURIComponent(r)).join('');

    fetch(url)
      .then(r=> r.ok? r.json(): Promise.reject(r.statusText))
      .then(data=>{
        const [hdrP, ...rowsP] = data.valueRanges[0].values;
        const places = rowsP.map(r=>{
          const o=Object.fromEntries(hdrP.map((h,i)=>[h,r[i]||'']));
          const [lat,lng]=o.Coordinates.split(',').map(Number);
          return {
            id:o.PlaceID, name:o.Name,
            category:o.Category, subcategory:o.Subcategory,
            region:o.Region, notes:o.Notes,
            visited:o.Visited.trim().toUpperCase()==='Y',
            latlng:[lat,lng], mapsLink:o.MapsLink, appleLink:o.AppleMapsLink
          };
        });

        const [hdrR, ...rowsR] = data.valueRanges[1].values;
        const reviewsBy={};
        rowsR.forEach(r=>{
          const o=Object.fromEntries(hdrR.map((h,i)=>[h,r[i]||'']));
          const photos=(o.PhotoURL||'').split(/\s*,\s*/).filter(u=>u);
          (reviewsBy[o.PlaceID]||=[]).push({
            date:o.VisitDate, rating:+o.Rating||0,
            review:o.Review, photos
          });
        });

        initialize(places, reviewsBy);
      })
      .catch(console.error);

    function initialize(places, reviewsBy){
      const map=L.map('map',{zoomControl:false}).setView([21.3069,-157.8583],11);
      L.control.zoom({position:'topright'}).addTo(map);
      L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{
        attribution:'Â© Humanitarian OSM Team'
      }).addTo(map);
      const markerLayer=L.layerGroup().addTo(map);

      const filtersDiv=document.getElementById('filters'),
            toggleBtn=document.getElementById('toggleFilters');
      toggleBtn.addEventListener('click',()=>{
        filtersDiv.classList.toggle('expanded');
        toggleBtn.textContent = filtersDiv.classList.contains('expanded')
                              ? 'Hide Filters' : 'Show Filters';
      });
      filtersDiv.querySelectorAll('.panel').forEach(p=>p.remove());

      const catMap={}, regions=new Set();
      places.forEach(p=>{ (catMap[p.category]||=new Set()).add(p.subcategory);
                         if(p.region) regions.add(p.region); });
      const cats=Object.keys(catMap).sort(),
            alpha=arr=>arr.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

      function hslToHex(h,s,l){ l/=100; const a=s*Math.min(l,1-l)/100;
        const f=n=>{ const k=(n+h/30)%12;
          const c=l - a*Math.max(Math.min(k-3,9-k,1),-1);
          return Math.round(255*c).toString(16).padStart(2,'0');
        };
        return `#${f(0)}${f(8)}${f(4)}`; }
      const colors={}; cats.forEach((c,i)=>colors[c]=hslToHex(i*360/cats.length,60,50));

      const selSub=new Set(places.map(p=>`${p.category} - ${p.subcategory}`)),
            selReg=new Set(regions), selVis=new Set(['Been there','Not yet']);

      function makeCheckbox(val,setRef,label){
        const lbl=document.createElement('label'),
              cb =document.createElement('input');
        cb.type='checkbox'; cb.value=val; cb.checked=true;
        cb.onchange=()=>{cb.checked?setRef.add(val):setRef.delete(val); render();};
        lbl.append(cb,' ',label); return lbl;
      }
      function addPanel(title, items, isReg, toggleOnly=false){
        const p=document.createElement('div'); p.className='panel';
        const h=document.createElement('div'); h.className='panel-header';

        // master-toggle hibiscus
        if(!toggleOnly){
          const master=document.createElement('span');
          master.className='master-toggle';
          master.textContent='ðŸŒº';
          const body=document.createElement('div'); body.className='panel-body';
          master.addEventListener('click', e=>{
            e.stopPropagation();
            const cbs=body.querySelectorAll('input[type=checkbox]');
            const allChecked=Array.from(cbs).every(cb=>cb.checked);
            cbs.forEach(cb=>{
              cb.checked=!allChecked;
              const v=cb.value;
              isReg? (!allChecked?selReg.add(v):selReg.delete(v))
                   : (!allChecked?selSub.add(v):selSub.delete(v));
            });
            render();
          });
          h.append(master);
        }

        h.append(document.createTextNode(title));

        // color swatch
        if(!isReg && title!=='Visited?'){
          const sw=document.createElement('div'); sw.className='color-swatch';
          sw.style.background=colors[title]; h.append(sw);
        }

        // arrow
        const arr=document.createElement('span'); arr.className='arrow';
        arr.textContent='â–¶'; h.append(arr);

        const b=document.createElement('div'); b.className='panel-body';
        items.forEach(it=>{
          const full=isReg?it: title==='Visited?'?it:`${title} - ${it}`,
                ref =isReg?selReg: title==='Visited?'?selVis:selSub;
          b.append(makeCheckbox(full,ref,it));
        });

        h.addEventListener('click', ()=>{
          b.classList.toggle('active');
          arr.textContent=b.classList.contains('active')?'â–¼':'â–¶';
        });

        p.append(h,b);
        filtersDiv.append(p);
      }

      if(regions.size) addPanel('Region', alpha([...regions]), true);
      addPanel('Visited?',['Been there','Not yet'], false, true);
      cats.forEach(c=>addPanel(c, alpha([...catMap[c]]), false));

      function render(){
        markerLayer.clearLayers();
        places.forEach(p=>{
          if(!selVis.has(p.visited?'Been there':'Not yet')) return;
          if(!selSub.has(`${p.category} - ${p.subcategory}`)) return;
          if(p.region && !selReg.has(p.region)) return;

          let popup=`<strong>${p.name}</strong><br>`;
          if(p.notes) popup+=`${p.notes}<br>`;
          popup+=`<em>${p.category} â€“ ${p.subcategory}`+
                 (p.region?` / ${p.region}`:'')+`</em><br>`;

          const revs=(reviewsBy[p.id]||[]).slice()
                     .sort((a,b)=>b.date.localeCompare(a.date));
          if(revs.length){
            popup+='â˜…'.repeat(revs[0].rating)+'<br>';
            popup+=`<details><summary>${revs.length} review${revs.length>1?'s':''}</summary>
                    <div class="review-carousel">`;
            revs.forEach(r=>{
              popup+=`<div class="review-item"><strong>${r.date}</strong><p>${r.review}</p>`;
              r.photos.forEach(u=>popup+=`<a href="${u}" target="_blank">View photo</a>`);
              popup+=`</div>`;
            });
            popup+=`</div></details>`;
          }

          if(p.mapsLink)  popup+=`<a href="${p.mapsLink}" target="_blank">Google Maps</a>`;
          if(p.appleLink) popup+=`<br><a href="${p.appleLink}" target="_blank">Apple Maps</a>`;

          L.marker(p.latlng,{
            icon:L.divIcon({
              html:`<svg width="24" height="35" viewBox="0 0 24 35"><path fill="${colors[p.category]}" stroke="${p.visited?'#DAA520':'#555'}" stroke-width="2" d="M12 0C7.03 0 3 4.03 3 9 c0 6.75 9 19.5 9 19.5 s9-12.75 9-19.5 c0-4.97-4.03-9-9-9 zm0 13.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"/></svg>`,
              className:'leaflet-div-icon',
              iconSize:[24,35], iconAnchor:[12,35], popupAnchor:[0,-35]
            })
          }).addTo(markerLayer);
        });
      }

      render();
    }
  })();
  </script>
</body>
</html>
