<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Oahu Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""/>

  <!-- Fallback Font from Google (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Rock+Salt&display=swap"
        rel="stylesheet"/>

  <style>
    /* ============================= */
    /*        Custom Fonts          */
    /* ============================= */
    @font-face {
      font-family: 'Bardy';
      /* Change this path to your Bardy font file */
      src: url('/MapResources/fonts/Bardy.woff') format('woff');
    }
    @font-face {
      font-family: 'Dorgan';
      /* Change this path to your Dorgan font file */
      src: url('/MapResources/fonts/Dorgan.woff') format('woff');
    }

    /* ============================= */
    /*   Base & Leaflet Overrides   */
    /* ============================= */
    html, body { margin:0; height:100%; font-family:sans-serif; }
    #map { height:100%; }
    .leaflet-div-icon { background:transparent!important; border:none!important; }

    /* ============================= */
    /*        Filters Panel         */
    /* ============================= */
    .filters {
      position:absolute;
      top:10px; left:10px;
      z-index:1000;
      /* Background color: change if desired */
      background:rgba(255,249,230,0.95);
      border-radius:8px;
      overflow:hidden;
      max-height:40px;
      width:auto;
      transition:max-height .3s, width .3s;
    }
    .filters.expanded {
      max-height:calc(100vh - 20px);
      width:280px;
      overflow-y:auto;
    }

    /* Toggle button style */
    #toggleFilters {
      display:block; width:100%; padding:8px;
      /* Button background color */
      background:#E7D8C4;
      border:none; border-bottom:1px solid #ddd;
      font-family:'Dorgan',cursive;
      cursor:pointer;
    }

    /* ============================= */
    /*       Panel & Checkboxes     */
    /* ============================= */
    .panel { margin:8px; }
    .panel-header {
      display:flex;
      align-items:center;
      padding:6px 8px;
      /* Header background color */
      background:#E7D8C4;
      border-radius:6px;
      cursor:pointer;
      font-family:'Bardy',cursive;
      /* Header font size */
      font-size:1.6em;
      /* Text color */
      color: #e3b505;
      /* Text shadow: horizontal, vertical, blur, color */
      text-shadow: 2px 2px 0 #db504a;
    }
    .panel-header input[type="checkbox"],
    .panel-body input[type="checkbox"] {
      appearance:none;
      width:18px; height:18px;
      margin-right:12px;
      /* Checkbox border color */
      border:2px solid #D0B59A;
      border-radius:3px;
      position:relative;
      cursor:pointer;
    }
    input[type="checkbox"]:checked { border:none; }
    input[type="checkbox"]:checked::after {
      /* Emoji icon on check: controlled by data-emoji in JS */
      content: attr(data-emoji);
      position:absolute;
      top:-2px; left:-2px;
      font-size:22px; line-height:18px;
      pointer-events:none;
    }
    .panel-header .arrow {
      /* Arrow margin: keep baseline spacing here */
      margin-left:8px;
      font-weight:bold;
    }

    /* ============================= */
    /*    Panel Body & Labels       */
    /* ============================= */
    .panel-body {
      display:none;
      padding:8px 12px;
      /* Body background color */
      background:#FAF1D2;
      border-radius:6px;
    }
    .panel-body.active { display:block; }
    .panel-body label {
      display:block;
      margin-bottom:6px;
      font-family:'Dorgan',sans-serif;
      font-size:1.1em;
      position:relative;
    }

    /* ============================= */
    /*         Popup Styles         */
    /* ============================= */
    .leaflet-popup-content-wrapper {
      max-height:80vh;
      overflow:auto;
      font-family:'Dorgan',sans-serif;
    }
    .review-carousel {
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding:6px 0;
    }
    .review-item {
      flex:0 0 180px;
      background:#fff;
      border:1px solid #ddd;
      padding:6px;
      border-radius:4px;
      box-sizing:border-box;
    }
    .review-item a { display:block; margin-top:4px; font-size:0.9em; }
    .review-item strong { display:block; margin-bottom:4px; }
    .review-item p { margin:0 0 4px; }
  </style>
</head>
<body>
  <!-- Filter toggle and container -->
  <div class="filters" id="filters">
    <button id="toggleFilters">Show Filters</button>
  </div>
  <!-- Main map element -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
  /* =========================================================== */
  /*                       CONFIGURATION                        */
  /*   Swap out values below for a new map:                     */
  /* ----------------------------------------------------------- */
  const CONFIG = {
    // Google Sheets settings
    sheetId:    '1XBG0uONiQoPvUxqz6V4BJBsOckDM2cahH4WylqOdz74',  // <--- update sheet ID
    apiKey:     'AIzaSyDiUAu4Uii6gAltbyJ8G2UkLMUdydyd9Jw',      // <--- update API key
    ranges:     ['Places!A:J','Reviews!A:E'],                 // <--- update sheet ranges

    // Map viewport
    mapCenter:  [21.3069, -157.8583],  // <--- update center [lat, lng]
    mapZoom:    11,                    // <--- update zoom level

    // Tile layer
    tileUrl:     'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
    attribution: '© Humanitarian OSM Team',                            

    // Category colors (no repeats until exhausted)
    baseColors: ['#FCBF49','#D62828','#E8B5BD','#4D7D5C','#528ED1','#deff8d'],  // <--- update hex list

    // Checkbox emojis
    emojiList:  ['🤙🏼','🧜🏼‍♀️','🏄🏼‍♂️','🏄🏻‍♀️','🐓','🐳','🐠','🦈',
                 '🪸','🪼','🌺','🥥','🍍','🍧','🤿','🌋',
                 '🏝️','🛵','👙','🌴','⛱️','⛵','⚓']           // <--- update emojis
  };
  /* =========================================================== */

  (function(){
    // Shuffle helper
    function shuffle(arr) {
      let m = arr.length;
      while (m) {
        const i = Math.floor(Math.random() * m--);
        [arr[m], arr[i]] = [arr[i], arr[m]];
      }
      return arr;
    }
    // Fallback random color
    function randomColor() {
      const h = Math.floor(Math.random() * 360);
      return `hsl(${h},60%,50%)`;
    }

    // Build Sheets API URL
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.sheetId}` +
                `/values:batchGet?key=${CONFIG.apiKey}` +
                CONFIG.ranges.map(r => `&ranges=${encodeURIComponent(r)}`).join('');

    // Fetch data
    fetch(url)
      .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
      .then(data => {
        /* Parse Places sheet */
        const [hdrP, ...rowsP] = data.valueRanges[0].values;
        const places = rowsP.map(r => {
          const o = Object.fromEntries(hdrP.map((h,i) => [h, r[i]||'']));
          const [lat,lng] = o.Coordinates.split(',').map(Number);
          return {
            id: o.PlaceID,
            name: o.Name,
            category: o.Category,
            subcategory: o.Subcategory,
            region: o.Region,
            notes: o.Notes,
            visited: o.Visited.trim().toUpperCase() === 'Y',
            latlng: [lat,lng],
            mapsLink: o.MapsLink,
            appleLink: o.AppleMapsLink
          };
        });
        /* Parse Reviews sheet */
        const [hdrR, ...rowsR] = data.valueRanges[1].values;
        const reviewsBy = {};
        rowsR.forEach(r => {
          const o = Object.fromEntries(hdrR.map((h,i) => [h, r[i]||'']));
          const photos = (o.PhotoURL||'').trim().split(/\s*,\s*/).filter(Boolean);
          (reviewsBy[o.PlaceID] ||= []).push({
            date: o.VisitDate,
            rating: +o.Rating || 0,
            text: o.Review,
            photos
          });
        });
        // Initialize map
        initializeMap(places, reviewsBy);
      })
      .catch(console.error);

    /* Creates the map, filters, and markers */
    function initializeMap(places, reviewsBy) {
      const map = L.map('map', { zoomControl:false })
                   .setView(CONFIG.mapCenter, CONFIG.mapZoom);
      L.control.zoom({ position:'topright' }).addTo(map);
      L.tileLayer(CONFIG.tileUrl, { attribution:CONFIG.attribution }).addTo(map);
      const markerLayer = L.layerGroup().addTo(map);

      // Build category/subcategory map & regions set
      const catMap = {}, regions = new Set();
      places.forEach(p => {
        (catMap[p.category] ||= new Set()).add(p.subcategory);
        if (p.region) regions.add(p.region);
      });
      // Assign colors
      const pool = shuffle(CONFIG.baseColors.slice());
      const categoryColors = {};
      Object.keys(catMap).forEach(c => {
        categoryColors[c] = pool.length ? pool.pop() : randomColor();
      });

      // Filter states
      const selSub = new Set(places.map(p => `${p.category} - ${p.subcategory}`));
      const selReg = new Set(regions);
      const selVis = new Set(['Been there','Not yet']);

      // Build filter UI
      const filtersDiv = document.getElementById('filters');
      const toggleBtn  = document.getElementById('toggleFilters');
      toggleBtn.addEventListener('click', ()=>{
        const e = filtersDiv.classList.toggle('expanded');
        toggleBtn.textContent = e ? 'Hide Filters' : 'Show Filters';
      });

      function makeCheckbox(val, setRef, labelText) {
        const label = document.createElement('label');
        const cb    = document.createElement('input');
        cb.type    = 'checkbox'; cb.value  = val; cb.checked = true;
        cb.dataset.emoji = CONFIG.emojiList[Math.floor(Math.random()*CONFIG.emojiList.length)];
        cb.addEventListener('change', ()=>{
          cb.checked ? setRef.add(val) : setRef.delete(val);
          renderMarkers();
        });
        label.append(cb, ' ', labelText);
        return label;
      }

      function addPanel(title, items, isRegion=false, toggleOnly=false) {
        const panel = document.createElement('div'); panel.className = 'panel';
        const head  = document.createElement('div'); head.className = 'panel-header';
        if (!toggleOnly) {
          const lab    = document.createElement('label');
          const master= document.createElement('input');
          master.type    = 'checkbox'; master.checked = true;
          master.dataset.emoji = CONFIG.emojiList[Math.floor(Math.random()*CONFIG.emojiList.length)];
          master.addEventListener('click', e=>e.stopPropagation());
          master.addEventListener('change', ()=>{
            const all = master.checked;
            panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
              if (cb!==master) {
                cb.checked = all;
                const k=cb.value;
                if (isRegion) all? selReg.add(k) : selReg.delete(k);
                else          all? selSub.add(k) : selSub.delete(k);
              }
            });
            renderMarkers();
          });
          lab.append(master);
          head.append(lab);
        }
        head.append(document.createTextNode(title));
        if (!isRegion && title!=="Visited?") {
          const sw=document.createElement('div');
          sw.className='color-swatch';
          sw.style.background = categoryColors[title];
          head.append(sw);
        }
        const arr=document.createElement('span');
        arr.className='arrow';
        arr.textContent='▶';
        head.append(arr);
        const body=document.createElement('div');
        body.className='panel-body';
        items.forEach(item=>{
          const full=isRegion?item:title==="Visited?"?item:`${title} - ${item}`;
          const ref= isRegion?selReg:title==="Visited?"?selVis:selSub;
          body.append(makeCheckbox(full,ref,item));
        });
        head.addEventListener('click', ()=>{
          const open= body.classList.toggle('active');
          arr.textContent= open?'▼':'▶';
        });
        panel.append(head,body);
        filtersDiv.append(panel);
      }

      // Build all panels
      if (regions.size) addPanel('Region',[...regions].sort(),true);
      addPanel('Visited?',['Been there','Not yet'],false,true);
      if (catMap['Food']) addPanel('Food',[...catMap['Food']].sort());
      if (catMap['Sweet Treats']) addPanel('Sweet Treats',[...catMap['Sweet Treats']].sort());
      Object.keys(catMap)
        .filter(c=>!['Food','Sweet Treats'].includes(c))
        .sort()
        .forEach(c=> addPanel(c,[...catMap[c]].sort()));

      // Render map markers based on filters
      function renderMarkers() {
        markerLayer.clearLayers();
        places.forEach(p=>{
          if (!selVis.has(p.visited?'Been there':'Not yet')) return;
          if (!selSub.has(`${p.category} - ${p.subcategory}`)) return;
          if (p.region && !selReg.has(p.region)) return;
        let popup=`<strong>${p.name}</strong><br>` +
                  (p.notes?`${p.notes}<br>`:'') +
                  `<em>${p.category} – ${p.subcategory}` +
                  (p.region?` / ${p.region}`:'') + `</em><br>`;
        const revs=(reviewsBy[p.id]||[]).slice()
                     .sort((a,b)=>b.date.localeCompare(a.date));
        if (revs.length) {
          popup+='★'.repeat(revs[0].rating)+'<br>' +
                 `<details><summary>${revs.length} review${revs.length>1?'s':''}</summary>` +
                 `<div class="review-carousel">`;
          revs.forEach(r=>{
            popup+=`<div class="review-item"><strong>${r.date}</strong><p>${r.text}</p>`;
            r.photos.forEach( u=> popup+=`<a href="${u}" target="_blank">View photo</a>`);
            popup+=`</div>`;
          });
          popup+=`</div></details>`;
        }
        if (p.mapsLink)  popup+=`<a href="${p.mapsLink}" target="_blank">Google Maps</a>`;
        if (p.appleLink) popup+=`<br><a href="${p.appleLink}" target="_blank">Apple Maps</a>`;
```}]}

