<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Oahu – Tropical Filters</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- Tiki-style & Base Fonts -->
  <style>
    @font-face {
      font-family: 'GlaryTropic';
      src: url('/MapResources/glary-tropic-trial.smooth.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }
    body, html {
      margin:0; padding:0;
      font-family:'GlaryTropic', 'Open Sans', sans-serif;
      background:#F0EDE5;
      height:100%;
    }
    #map { height:100vh; }

    /* Bamboo frame (nine-slice) */
    .filters.expanded {
      border: 30px solid transparent;
      border-image: url('/MapResources/pngs/bamboo-frame.png') 30 fill stretch;
    }

    /* Reset Leaflet icon background */
    .leaflet-div-icon {
      background: transparent !important;
      border: none !important;
    }

    /* Filter panel base */
    .filters {
      position:absolute; top:20px; left:20px; z-index:1000;
      background:rgba(255,255,240,0.95);
      border-radius:12px;
      max-height:40px; overflow:hidden;
      transition: max-height .3s, width .3s;
    }
    .filters.expanded {
      max-height:calc(100vh - 40px);
      width:300px;
    }
    #toggleFilters {
      display:block; width:100%; padding:10px;
      background:linear-gradient(135deg,#FF9A8B,#FAD0C4);
      border:none;
      font-family:'GlaryTropic', cursive;
      font-size:1.2em; color:#5D4037;
      cursor:pointer;
    }

    /* Panel styles */
    .panel { margin:0; }
    .panel-header {
      display:flex; align-items:center;
      padding:8px 12px;
      background:linear-gradient(135deg,#FF9A8B,#FAD0C4);
      border-bottom:2px solid #D96459;
      font-family:'GlaryTropic', cursive;
      color:#5D4037;
      cursor:pointer;
    }
    .panel-header::before {
      content: url('/MapResources/pngs/hibiscus.png');
      display:inline-block;
      width:20px; height:20px; margin-right:8px;
    }
    .panel-header input { margin-right:10px; }
    .panel-header .arrow { margin-left:auto; font-weight:bold; }
    .panel-header:hover { animation: sway 2s ease-in-out infinite alternate; }
    @keyframes sway {
      from { transform: rotate(-1deg); }
      to   { transform: rotate(1deg); }
    }

    /* Panel body with palm-leaf texture */
    .panel-body {
      display:none;
      padding:12px 16px;
      background:rgba(255,248,225,0.9);
      background-image:url('/MapResources/pngs/palm-pattern.png');
      background-size:200px auto;
      font-size:.9em; overflow:auto;
      animation: slideFadeIn .2s ease-out;
    }
    .panel-body.active { display:block; }
    @keyframes slideFadeIn {
      from { opacity:0; transform:translateY(-10px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .panel-body label { display:block; margin-bottom:8px; }

    /* Popup & Review carousel tweaks */
    .leaflet-popup-content-wrapper {
      max-height:80vh; overflow:auto;
    }
    .review-carousel {
      display:flex; overflow-x:auto; gap:8px; padding:6px 0;
    }
    .review-item {
      flex:0 0 180px;
      background:#fff; border:1px solid #ddd;
      padding:8px; border-radius:6px; box-sizing:border-box;
    }
    .review-item a { display:block; margin-top:6px; color:#0077CC; }
  </style>
</head>
<body>
  <div class="filters" id="filters">
    <button id="toggleFilters">Show Filters</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    // Fetch Google Sheets data
    const sheetId = '1XBG0uONiQoPvUxqz6V4BJBsOckDM2cahH4WylqOdz74';
    const apiKey  = 'AIzaSyDiUAu4Uii6gAltbyJ8G2UkLMUdydyd9Jw';
    const ranges  = ['Places!A:J','Reviews!A:E'];
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values:batchGet?key=${apiKey}`
                + ranges.map(r=>`&ranges=${encodeURIComponent(r)}`).join('');
    fetch(url)
      .then(res=> res.ok ? res.json() : Promise.reject(res.statusText))
      .then(data=>{
        // Parse places
        const [hdrP,...rowsP] = data.valueRanges[0].values;
        const places = rowsP.map(r=>{
          const o = Object.fromEntries(hdrP.map((h,i)=>[h,r[i]||'']));
          const [lat,lng] = o.Coordinates.split(',').map(Number);
          return {
            id:o.PlaceID, name:o.Name,
            category:o.Category, subcategory:o.Subcategory,
            region:o.Region, notes:o.Notes,
            visited:o.Visited.trim().toUpperCase()==='Y',
            latlng:[lat,lng],
            mapsLink:o.MapsLink, appleLink:o.AppleMapsLink
          };
        });
        // Parse reviews
        const [hdrR,...rowsR] = data.valueRanges[1].values;
        const reviewsBy = {};
        rowsR.forEach(r=>{
          const o = Object.fromEntries(hdrR.map((h,i)=>[h,r[i]||'']));
          const photos = (o.PhotoURL||'').split(/\s*,\s*/).filter(Boolean);
          (reviewsBy[o.PlaceID] ||= []).push({
            date:o.VisitDate, rating:+o.Rating||0,
            text:o.Review, photos
          });
        });
        initialize(places, reviewsBy);
      })
      .catch(console.error);

    function initialize(places, reviewsBy){
      // Map setup
      const map = L.map('map',{zoomControl:false}).setView([21.3069,-157.8583],11);
      L.control.zoom({position:'topright'}).addTo(map);
      L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{
        attribution:'© Humanitarian OSM Team'
      }).addTo(map);
      const markerLayer = L.layerGroup().addTo(map);

      // Build filters
      const catMap = {}, regions = new Set();
      places.forEach(p=>{
        (catMap[p.category] ||= new Set()).add(p.subcategory);
        if(p.region) regions.add(p.region);
      });
      const categories = Object.keys(catMap);
      const alpha = arr => arr.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));

      // Color palette
      const palette = alpha([...categories]);
      const colors = {};
      palette.forEach((cat,i)=>{
        const h=i*360/palette.length, s=60, l=50;
        const a=s*Math.min(l/100,1-l/100)/100;
        const toHex=n=>{
          const k=(n+h/30)%12;
          const c=l/100 - a*Math.max(Math.min(k-3,9-k,1),-1);
          return Math.round(255*c).toString(16).padStart(2,'0');
        };
        colors[cat]=`#${toHex(0)}${toHex(8)}${toHex(4)}`;
      });

      // State
      const selSub = new Set(places.map(p=>`${p.category} - ${p.subcategory}`));
      const selReg = new Set(regions);
      const selVis = new Set(['Been there','Not yet']);

      // DOM refs
      const filtersDiv = document.getElementById('filters');
      const toggleBtn  = document.getElementById('toggleFilters');
      toggleBtn.addEventListener('click', ()=>{
        filtersDiv.classList.toggle('expanded');
        toggleBtn.textContent = filtersDiv.classList.contains('expanded')
                              ? 'Hide Filters' : 'Show Filters';
      });

      function makeCheckbox(value,setRef,labelText){
        const label=document.createElement('label');
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.value=value; cb.checked=true;
        cb.addEventListener('change',()=>{
          cb.checked? setRef.add(value) : setRef.delete(value);
          renderMarkers();
        });
        label.append(cb,' ',labelText);
        return label;
      }

      function addPanel(title,items,isRegion,toggleOnly=false){
        const panel=document.createElement('div'); panel.className='panel';
        const hdr=document.createElement('div'); hdr.className='panel-header';
        if(!toggleOnly){
          const master=document.createElement('input');
          master.type='checkbox'; master.checked=true;
          master.addEventListener('click',e=>e.stopPropagation());
          master.addEventListener('change',()=>{
            const all=master.checked;
            panel.querySelectorAll('input[type=checkbox]').forEach(cb=>{
              if(cb!==master){
                cb.checked=all;
                const key=cb.value;
                if(isRegion) all? selReg.add(key): selReg.delete(key);
                else         all? selSub.add(key): selSub.delete(key);
              }
            });
            renderMarkers();
          });
          hdr.append(master);
        }
        hdr.append(document.createTextNode(title));
        if(!isRegion && title!=='Visited?'){
          const sw=document.createElement('div'); sw.className='color-swatch';
          sw.style.background=colors[title]; hdr.append(sw);
        }
        const arrw=document.createElement('span'); arrw.className='arrow'; arrw.textContent='▶';
        hdr.append(arrw);

        const body=document.createElement('div'); body.className='panel-body';
        items.forEach(it=>{
          const full=isRegion? it : title==='Visited?'? it : `${title} - ${it}`;
          const ref=isRegion? selReg : title==='Visited?'? selVis : selSub;
          body.append(makeCheckbox(full,ref,it));
        });
        hdr.addEventListener('click',()=>{
          body.classList.toggle('active');
          arrw.textContent= body.classList.contains('active')?'▼':'▶';
        });

        panel.append(hdr, body);
        filtersDiv.append(panel);
      }

      // Build panels
      if(regions.size) addPanel('Region',      alpha([...regions]), true);
      addPanel('Visited?', ['Been there','Not yet'], false, true);
      if(categories.includes('Food'))         addPanel('Food',         alpha([...catMap.Food]), false);
      if(categories.includes('Sweet Treats')) addPanel('Sweet Treats', alpha([...catMap['Sweet Treats']]), false);
      alpha(categories.filter(c=>c!=='Food'&&c!=='Sweet Treats'))
        .forEach(c=> addPanel(c, alpha([...catMap[c]]), false));

      // Render markers
      function renderMarkers(){
        markerLayer.clearLayers();
        places.forEach(p=>{
          if(!selVis.has(p.visited?'Been there':'Not yet')) return;
          if(!selSub.has(`${p.category} - ${p.subcategory}`)) return;
          if(p.region && !selReg.has(p.region)) return;

          let popup=`<strong>${p.name}</strong><br>`;
          if(p.notes) popup+=`${p.notes}<br>`;
          popup+=`<em>${p.category} – ${p.subcategory}`+
                 (p.region?` / ${p.region}`:'')+`</em><br>`;

          const revs=(reviewsBy[p.id]||[]).slice().sort((a,b)=>b.date.localeCompare(a.date));
          if(revs.length){
            popup+='★'.repeat(revs[0].rating)+'<br>';
            popup+=`<details><summary>${revs.length} review${revs.length>1?'s':''}</summary>
                    <div class="review-carousel">`;
            revs.forEach(r=>{
              popup+=`<div class="review-item"><strong>${r.date}</strong><p>${r.text}</p>`;
              r.photos.forEach(u=> popup+=`<a href="${u}" target="_blank">View photo</a>`);
              popup+=`</div>`;
            });
            popup+=`</div></details>`;
          }

          if(p.mapsLink)  popup+=`<a href="${p.mapsLink}" target="_blank">Google Maps</a>`;
          if(p.appleLink) popup+=`<br><a href="${p.appleLink}" target="_blank">Apple Maps</a>`;

          const strokeColor=p.visited?'#DAA520':'#555';
          const svgIcon=`<svg width="24" height="35" viewBox="0 0 24 35"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill="${colors[p.category]}"
                                  stroke="${strokeColor}" stroke-width="2"
                                  d="M12 0C7.03 0 3 4.03 3 9 c0 6.75 9 19.5 9 19.5 s9-12.75 9-19.5 c0-4.97-4.03-9-9-9 zm0 13.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"/>
                         </svg>`;

          L.marker(p.latlng,{
            icon:L.divIcon({
              html:svgIcon,
              className:'leaflet-div-icon',
              iconSize:[24,35],
              iconAnchor:[12,35],
              popupAnchor:[0,-35]
            })
          })
          .bindPopup(popup,{autoPan:true})
          .addTo(markerLayer);
        });
      }

      renderMarkers();
    }
  })();
  </script>
</body>
</html>
